{% extends "base.html" %}

{% block title %}{{ _('Private Venting Room') }} - MindCare{% endblock %}

{% block extra_head %}
<style>

    #notes-container {
    position: relative;
    width: 100%;
    min-height: 70vh;

    /* ðŸªµ Corkboard texture */
    background: url('https://www.transparenttextures.com/patterns/cork-board.png');
    background-size: cover;

    border: 6px solid #8d6e63;  /* wooden frame feel */
    border-radius: 12px;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.3),
                0 4px 20px rgba(0,0,0,0.4);
    margin-top: 30px;
    padding: 20px;
}


.venting-room {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
    position: relative;
    overflow: hidden;
}

.venting-room::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g"><stop offset="20%" stop-color="%23ffffff" stop-opacity="0.1"/><stop offset="50%" stop-color="%23ffffff" stop-opacity="0.05"/><stop offset="100%" stop-color="%23ffffff" stop-opacity="0"/></radialGradient></defs><circle cx="20" cy="20" r="20" fill="url(%23g)"/><circle cx="80" cy="80" r="30" fill="url(%23g)"/></svg>');
    animation: floating 20s infinite linear;
    opacity: 0.3;
}

@keyframes floating {
    0% { transform: translateY(0px) rotate(0deg); }
    100% { transform: translateY(-100px) rotate(360deg); }
}

.sticky-note {
    width: 280px;
    height: 280px;
    background: #ffeb3b;
    background: linear-gradient(45deg, #ffeb3b 0%, #fff176 100%);
    position: relative;
    margin: 2rem auto;
    border-radius: 0 0 0 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    transform: rotate(-2deg);
    transition: all 0.3s ease;
    cursor: grab;
    border: 1px solid #f57f17;
}

.sticky-note::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-left: 20px solid #f57f17;
    border-top: 20px solid transparent;
    border-bottom: 20px solid transparent;
    transform: rotate(45deg);
}

.sticky-note::after {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 20px;
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
}

.sticky-note.dragging {
    cursor: grabbing;
    z-index: 1000;
    transform: rotate(5deg) scale(1.05);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.sticky-note.burning {
    animation: burn 4s ease-in-out forwards;
    pointer-events: none;
}

@keyframes burn {
    0% { 
        transform: rotate(-2deg) scale(1);
        background: linear-gradient(45deg, #ffeb3b 0%, #fff176 100%);
        filter: brightness(1);
    }
    20% { 
        background: linear-gradient(45deg, #ff9800 0%, #ffb74d 100%);
        filter: brightness(1.2);
    }
    40% { 
        background: linear-gradient(45deg, #ff5722 0%, #ff8a65 100%);
        filter: brightness(1.5);
        transform: rotate(-2deg) scale(0.95);
    }
    60% { 
        background: linear-gradient(45deg, #d32f2f 0%, #f44336 100%);
        filter: brightness(2) blur(1px);
        transform: rotate(-2deg) scale(0.8);
    }
    80% { 
        background: linear-gradient(45deg, #424242 0%, #616161 100%);
        filter: brightness(0.5) blur(2px);
        transform: rotate(-2deg) scale(0.6);
    }
    100% { 
        background: linear-gradient(45deg, #212121 0%, #424242 100%);
        filter: brightness(0.2) blur(3px);
        transform: rotate(-2deg) scale(0.3);
        opacity: 0;
    }
}

.fire-effect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    border-radius: inherit;
}

.flame {
    position: absolute;
    width: 20px;
    height: 40px;
    background: radial-gradient(circle, #ff6b35 0%, #ff9500 50%, transparent 70%);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    animation: flicker 0.5s infinite alternate;
}

@keyframes flicker {
    0% { transform: scale(1) rotate(-2deg); opacity: 0.8; }
    100% { transform: scale(1.1) rotate(2deg); opacity: 1; }
}

.ash-particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: #616161;
    border-radius: 50%;
    animation: ashFloat 4s linear forwards;
}

@keyframes ashFloat {
    0% { 
        opacity: 1;
        transform: translateY(0) rotate(0deg);
    }
    100% { 
        opacity: 0;
        transform: translateY(-200px) rotate(360deg) translateX(50px);
    }
}

.note-textarea {
    width: 100%;
    height: 200px;
    background: transparent;
    border: none;
    outline: none;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    font-size: 16px;
    color: #333;
    padding: 30px 20px 20px 20px;
    resize: none;
    line-height: 1.4;
}

.burn-zone {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 220px;
    height: 120px;
    background: radial-gradient(ellipse, rgba(255,107,53,0.3) 0%, rgba(255,149,0,0.2) 50%, transparent 70%);
    border-radius: 50%;
    border: 3px dashed #ff6b35;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #ff6b35;
    transition: all 0.3s ease;
    cursor: pointer;
    z-index: 1500; /* stays on top */
}


.burn-zone:hover {
    background: radial-gradient(ellipse, rgba(255,107,53,0.5) 0%, rgba(255,149,0,0.3) 50%, transparent 70%);
    transform: translateX(-50%) scale(1.1);
}

.burn-zone.active {
    background: radial-gradient(ellipse, rgba(255,107,53,0.8) 0%, rgba(255,149,0,0.6) 50%, rgba(255,87,34,0.2) 70%);
    animation: burnZoneActive 1s infinite alternate;
}

@keyframes burnZoneActive {
    0% { box-shadow: 0 0 20px rgba(255,107,53,0.5); }
    100% { box-shadow: 0 0 40px rgba(255,107,53,0.8); }
}

.room-header {
    text-align: center;
    color: white;
    margin-bottom: 2rem;
}

.room-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.room-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.new-note-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    border-radius: 50px;
    padding: 15px 25px;
    background: linear-gradient(45deg, #4caf50, #8bc34a);
    border: none;
    color: white;
    font-weight: bold;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.new-note-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    background: linear-gradient(45deg, #45a049, #7cb342);
}

.instructions {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 15px;
    padding: 20px;
    margin: 20px auto;
    max-width: 600px;
    color: white;
    text-align: center;
}

.completion-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s ease;
    z-index: 2000;
}

.completion-message.show {
    opacity: 1;
    visibility: visible;
}

.healing-quotes {
    margin-top: 20px;
    font-style: italic;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="venting-room">
    <div class="container">
        <div class="room-header">
            <h1><i class="fas fa-fire"></i> {{ _('Private Venting Room') }}</h1>
            <p>{{ _('Write your worries on a sticky note, then burn them away to let go') }}</p>
        </div>
        
        <div class="instructions">
            <h5><i class="fas fa-lightbulb"></i> {{ _('How it works') }}:</h5>
            <p>1. {{ _('Click "New Note" to create a sticky note') }}<br>
               2. {{ _('Write down what\'s bothering you') }}<br>
               3. {{ _('Drag the note to the fire zone to burn it') }}<br>
               4. {{ _('Watch your worries turn to ash and disappear') }}</p>
        </div>
        
        <div id="notes-container"></div>
        
        <div class="burn-zone" id="burnZone">
            <i class="fas fa-fire"></i> {{ _('Drop to Burn') }}
        </div>
        
        <button class="new-note-btn" onclick="createNewNote()">
            <i class="fas fa-plus"></i> {{ _('New Note') }}
        </button>
    </div>
    
    <div class="completion-message" id="completionMessage">
        <div>
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4>{{ _('Your worries have been released') }}</h4>
            <p>{{ _('Sometimes letting go is the first step toward healing.') }}</p>
            <div class="healing-quotes">
                <p id="randomQuote"></p>
            </div>
            <button class="btn btn-primary mt-3" onclick="hideCompletionMessage()">
                {{ _('Continue') }}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let noteCounter = 0;
let isDragging = false;
let currentNote = null;

const healingQuotes = [
    "\"The only way out is through.\" - Robert Frost",
    "\"Healing doesn't mean the damage never existed. It means the damage no longer controls our lives.\"",
    "\"Your current situation is not your final destination.\"",
    "\"Be patient with yourself. Self-growth is tender; it's holy ground.\"",
    "\"You are braver than you believe, stronger than you seem, and more loved than you know.\"",
    "\"Healing is not about forgetting. It's about learning to remember without the pain.\"",
    "\"Progress, not perfection.\"",
    "\"Your mental health is a priority. Your happiness is essential. Your self-care is a necessity.\""
];

function createNewNote() {
    noteCounter++;
    const noteId = `note-${noteCounter}`;
    
    const note = document.createElement('div');
    note.className = 'sticky-note';
    note.id = noteId;

    // ðŸŽ¨ Random sticky note color
    const noteColors = [
        ['#ffeb3b', '#fff176'], // yellow
        ['#ffcc80', '#ffe0b2'], // orange
        ['#c5e1a5', '#e6ee9c'], // green
        ['#90caf9', '#bbdefb'], // blue
        ['#f48fb1', '#f8bbd0']  // pink
    ];
    const [c1, c2] = noteColors[Math.floor(Math.random() * noteColors.length)];
    note.style.background = `linear-gradient(45deg, ${c1} 0%, ${c2} 100%)`;

    // ðŸ“ Slightly random size
    const size = 220 + Math.floor(Math.random() * 60); // 220â€“280px
    note.style.width = size + 'px';
    note.style.height = size + 'px';

    // ðŸ“ Textarea
    const textarea = document.createElement('textarea');
    textarea.className = 'note-textarea';
    const placeholder1 = `{{ _("Write what's bothering you...") }}`;
    const placeholder2 = `{{ _('Then let it go.') }}`;
    textarea.placeholder = placeholder1 + "\n\n" + placeholder2;
    textarea.maxLength = 500;

    // ðŸ”¥ Fire effect container
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';

    note.appendChild(textarea);
    note.appendChild(fireEffect);

    // ðŸ“Œ Position notes in semi-grid with randomness
    const container = document.getElementById('notes-container');
    const cols = 4; // number of columns
    const rows = 3; // rough rows
    const colWidth = container.offsetWidth / cols;
    const rowHeight = container.offsetHeight / rows;

    const col = noteCounter % cols;
    const row = Math.floor(noteCounter / cols) % rows;

    note.style.position = 'absolute';
    note.style.left = col * colWidth + (Math.random() * 40 - 20) + 'px';
    note.style.top = row * rowHeight + (Math.random() * 40 - 20) + 'px';

    // ðŸŽ­ Random tilt & z-index
    note.style.transform = `rotate(${Math.random() * 15 - 7}deg)`;
    note.style.zIndex = Math.floor(Math.random() * 50);

    container.appendChild(note);

    // ðŸ–±ï¸ Dragging
    addDragFunctionality(note);

    textarea.addEventListener('mousedown', e => e.stopPropagation());
    textarea.addEventListener('click', e => e.stopPropagation());

    setTimeout(() => textarea.focus(), 100);

    // Auto-resize textarea
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
}

function addDragFunctionality(note) {
    let startX, startY, initialLeft, initialTop;
    
    note.addEventListener('mousedown', startDrag);
    note.addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        currentNote = note;
        note.classList.add('dragging');
        
        const rect = note.getBoundingClientRect();
        startX = (e.clientX || e.touches[0].clientX) - rect.left;
        startY = (e.clientY || e.touches[0].clientY) - rect.top;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        
        note.style.position = 'fixed';
        note.style.left = (clientX - startX) + 'px';
        note.style.top = (clientY - startY) + 'px';
        note.style.zIndex = '1000';
        
        // Check if over burn zone
        const burnZone = document.getElementById('burnZone');
        const burnRect = burnZone.getBoundingClientRect();
        const noteRect = note.getBoundingClientRect();
        
        const isOverBurnZone = (
            noteRect.left < burnRect.right &&
            noteRect.right > burnRect.left &&
            noteRect.top < burnRect.bottom &&
            noteRect.bottom > burnRect.top
        );
        
        if (isOverBurnZone) {
            burnZone.classList.add('active');
        } else {
            burnZone.classList.remove('active');
        }
    }
    
    function stopDrag(e) {
        if (!isDragging) return;
        
        isDragging = false;
        note.classList.remove('dragging');
        
        const burnZone = document.getElementById('burnZone');
        const burnRect = burnZone.getBoundingClientRect();
        const noteRect = note.getBoundingClientRect();
        
        const isOverBurnZone = (
            noteRect.left < burnRect.right &&
            noteRect.right > burnRect.left &&
            noteRect.top < burnRect.bottom &&
            noteRect.bottom > burnRect.top
        );
        
        if (isOverBurnZone) {
            burnNote(note);
        } else {
            // Return to container
            // Drop back randomly on the wall
            const container = document.getElementById('notes-container');
            const maxLeft = container.offsetWidth - 280;
            const maxTop = container.offsetHeight - 280;

            note.style.position = 'absolute';
            note.style.left = Math.max(0, Math.random() * maxLeft) + 'px';
            note.style.top = Math.max(0, Math.random() * maxTop) + 'px';
            note.style.zIndex = '';

        }
        
        burnZone.classList.remove('active');
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
    }
}

function burnNote(note) {
    // Add fire effect
    createFireEffect(note);

    // Start burning animation
    note.classList.add('burning');

    // Keep note visible until burn finishes
    note.style.zIndex = 2000; // bring to front

    // Create ash particles mid-way
    setTimeout(() => {
        createAshEffect(note);
    }, 1500);

    // Remove note after animation fully plays
    setTimeout(() => {
        note.remove();
        showCompletionMessage();
        saveVentingSession();
    }, 4000); // â¬… extended from 3000 â†’ 4000
}

function createFireEffect(note) {
    const fireEffect = note.querySelector('.fire-effect');
    
    for (let i = 0; i < 8; i++) {
        setTimeout(() => {
            const flame = document.createElement('div');
            flame.className = 'flame';
            flame.style.left = Math.random() * 80 + 10 + '%';
            flame.style.bottom = Math.random() * 20 + '%';
            flame.style.animationDelay = Math.random() * 0.5 + 's';
            fireEffect.appendChild(flame);
            
            setTimeout(() => {
                flame.remove();
            }, 2000);
        }, i * 200);
    }
}

function createAshEffect(note) {
    const noteRect = note.getBoundingClientRect();
    
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            const ash = document.createElement('div');
            ash.className = 'ash-particle';
            ash.style.left = noteRect.left + Math.random() * noteRect.width + 'px';
            ash.style.top = noteRect.top + Math.random() * noteRect.height + 'px';
            ash.style.position = 'fixed';
            ash.style.pointerEvents = 'none';
            ash.style.zIndex = '999';
            
            document.body.appendChild(ash);
            
            setTimeout(() => {
                ash.remove();
            }, 4000);
        }, i * 100);
    }
}

function showCompletionMessage() {
    const message = document.getElementById('completionMessage');
    const quote = document.getElementById('randomQuote');
    
    quote.textContent = healingQuotes[Math.floor(Math.random() * healingQuotes.length)];
    message.classList.add('show');
}

function hideCompletionMessage() {
    const message = document.getElementById('completionMessage');
    message.classList.remove('show');
}

function saveVentingSession() {
    // Save anonymized venting session for user progress tracking
    fetch('/save_venting_session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            timestamp: new Date().toISOString(),
            type: 'sticky_note_burn'
        })
    }).catch(error => {
        console.log('Session tracking not available');
    });
}

// Initialize with welcome note
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        createNewNote();
        const firstNote = document.querySelector('.note-textarea');
        if (firstNote) {
            const welcomeMsg = `{{ _('Welcome to your private space!') }}`;
            const mindMsg = `{{ _("Write anything that's weighing on your mind...") }}`;
            const dragMsg = `{{ _('Then drag this note to the fire to let it go.') }}`;
            firstNote.placeholder = welcomeMsg + "\n\n" + mindMsg + "\n\n" + dragMsg;
        }
    }, 500);
});

// Prevent default drag behavior on images
document.addEventListener('dragstart', function(e) {
    e.preventDefault();
});
</script>
{% endblock %}
